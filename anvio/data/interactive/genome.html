<html>
    <head>
        <title>Genome Display</title>
        <script type="text/javascript" src="js/tree.js"></script>
        <script type="text/javascript" src="js/utils.js"></script>
        <script type="text/javascript" src="lib/jquery/dist/jquery.min.js"></script>
        <style>
            * { 
                margin: 0; 
                padding: 0;
            }

            body, html { 
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            
            #canvas {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                overflow: auto;
            }
        </style>
    </head>

    <body>
        <canvas id="canvas"></canvas>
        <script type="text/javascript" src="js/genome.js"></script>
        <script type="text/javascript">
            const genomeViewer = new GenomeViewer({
                'canvas': document.getElementById('canvas'),
            });


            fetch('/data/get_neighbors').then((response) => {
                response.json().then((data) => {
                    for (const genome_name in data.contigs) {
                        let track = genomeViewer.getTrack(genome_name);

                        for (const contig_name in data.contigs[genome_name]) {
                            let contig_info = data.contigs[genome_name][contig_name];
                            
                            let contig = new Contig(genomeViewer);
                            contig.name = contig_name;
                            contig.length = contig_info.length;
                            track.contigs.push(contig);
                        }
                    }


                    data.genes.forEach((gene) => {
                        let genome_name = gene['genome_name'];

                        let track = genomeViewer.getTrack(genome_name);
                        track.contigs[0].genes.push(
                                new Gene({
                                  'viewer': genomeViewer,
                                  'gene_callers_id': gene['gene_callers_id'], 
                                  'start': gene['start'],
                                  'stop': gene['stop'],
                                  'direction': gene['direction']}));
                    });
                    let min = -1;

                    for (const cluster_name in data.clusters) {
                        let gene_start_pos = [];
                        data.clusters[cluster_name].forEach((cluster) => {
                            const {genome_name, gene_callers_id} = cluster;
                            
                            let track = genomeViewer.getTrack(genome_name);
                            let gene = track.contigs[0].getGene(gene_callers_id);
                            gene_start_pos.push(gene.start);
                        });
                        min = Math.min(...gene_start_pos);

                        data.clusters[cluster_name].forEach((cluster) => {
                            const {genome_name, gene_callers_id} = cluster;
                            
                            let track = genomeViewer.getTrack(genome_name);
                            let gene = track.contigs[0].getGene(gene_callers_id);

                            track.contigs[0].offsetX = min - gene.start;
                        });
                    }

                    genomeViewer.handleResize();
                    genomeViewer.center();
                });
            });

        </script>
    </body>
</html>
