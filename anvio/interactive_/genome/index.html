<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>anvi'o Genome Viewer</title>
    <link rel="stylesheet" href="/static/css/blaze.css">
    <script src="/static/js/worker.sql-wasm.js"></script>
  </head>
  <body>
    <div id="elm"></div>
    <script>
      {{dist}}
      async function initApp() {
          const metaResponse = await fetch('meta');
          const meta = await metaResponse.json();

          initSqlJs({ locateFile: filename => `/static/js/${filename}` })
            .then((SQL) => {
              Object.entries(meta.data).forEach(async function([dataId, details]) {
                console.log(`Fetching ${dataId}`);
                const content = await fetch(`data/${dataId}`);
                const arrayBuffer = await content.arrayBuffer();
                let uInt8Array = new Uint8Array(arrayBuffer);
                let db = new SQL.Database(uInt8Array);

                if (dataId == 'genome_storage') {
                    let { columns, values } = db.exec(`select * from contigs_basic_info;`)[0];
                    var app = Elm.Main.init({
                        node: document.getElementById('elm'),
                        flags: {
                          'contigs': values.map((row) => {
                            return row.reduce((obj, v, i) => {
                              let col = columns[i];
                              obj[(col == 'contig') ? 'name' : col] = v;
                              return obj;
                            }, {});
                          })
                        }
                    });
                }
              });
            });
      }

      initApp();
    </script>
  </body>
</html>
