<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>anvi'o Genome Viewer</title>
    <link rel="stylesheet" href="/static/css/blaze.css">
    <script src="/static/js/worker.sql-wasm.js"></script>
  </head>
  <body>
    <div id="elm"></div>
    <script>
      {{dist}}

      let dataMapConfig = {
        contigs : { db : 'genome_storage', table : 'contigs_basic_info'},
        genes : { db : 'genome_storage', table : 'genes_in_contigs'},
      }

      async function initApp() {
          const metaResponse = await fetch('meta');
          const meta = await metaResponse.json();
          const SQL = await initSqlJs({ locateFile: filename => `/static/js/${filename}` });

          let databases = {}
          let flags = {
            data : {
            }
          };

          let _dbs = {};
          let getRecords = async (db, query) => {
            let dbObj;
            if (_dbs.hasOwnProperty(db)) {
              // Read from cache
              dbObj = _dbs[db];
            }
            else {
              const content = await fetch(`data/${db}`);
              const arrayBuffer = await content.arrayBuffer();
              const uInt8Array = new Uint8Array(arrayBuffer);

              dbObj = new SQL.Database(uInt8Array);
              _dbs[db] = dbObj;
            }

            return dbObj.exec(query)[0];
          }

          for (const [ dataId, source ] of Object.entries(dataMapConfig)) {
            let stmt = `select * from ${source.table};`;
            let { columns, values } = await getRecords(source.db, stmt);
            flags.data[dataId] = values;
          }

          var app = Elm.Main.init({
                      node: document.getElementById('elm'),
                      flags: flags
          });
      }

      initApp();
    </script>
  </body>
</html>
