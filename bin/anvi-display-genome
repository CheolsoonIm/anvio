#!/usr/bin/env python
# -*- coding: utf-8
""""""
import os
import sys
import argparse
import cherrypy

import anvio
import anvio.utils as utils
import anvio.terminal as terminal

import anvio.interactive_ as interactive
import anvio.interactive_.genome as genome_viewer

from anvio.errors import ConfigError, FilesNPathsError, DictIOError, HDF5Error

run = terminal.Run()
progress = terminal.Progress()

AbsolutePath = lambda x: os.path.abspath(x)
Exist = lambda x: os.path.exists(x)
Join = lambda *x: os.path.join(*x)
Dirname = lambda x: os.path.dirname(x)


if __name__ == '__main__':
    # setup the command line user interface
    parser = argparse.ArgumentParser(description="Start an anvi'o server to display genome viewer")

    groupA = parser.add_argument_group('INPUT FILES', "Input files from the pangenome analysis.")
    groupP = parser.add_argument_group("SERVER CONFIGURATION", "For power users.")

    groupA.add_argument(*anvio.A('pan-db'), **anvio.K('pan-db', {'required': False}))
    groupA.add_argument(*anvio.A('genomes-storage'), **anvio.K('genomes-storage', {'required': False}))
    groupP.add_argument(*anvio.A('ip-address'), **anvio.K('ip-address'))
    groupP.add_argument(*anvio.A('port-number'), **anvio.K('port-number'))

    args = anvio.get_args(parser)

    try:
        args.port_number = utils.get_port_num(args.port_number, args.ip_address, run=run)
        GetOrNone = lambda x: args.__dict__[x] if x in args.__dict__ else None
        pan_db_path = GetOrNone('pan_db')
        genomes_storage_path = GetOrNone('genomes_storage')
        project_path = GetOrNone('project')

        app = interactive.ElmApp(project_file = AbsolutePath(Join(os.getcwd(), project_path or 'project.json')),
                                app_root = Dirname(genome_viewer.__file__))

        server = interactive.HttpServer(ip_address = GetOrNone('ip_address'),
                               port = GetOrNone('port_number'))

        server.run_application(app, '/genome')
        server.start()
    except ConfigError as e:
        print(e)
        sys.exit(-1)
    except FilesNPathsError as e:
        print(e)
        sys.exit(-2)
    except DictIOError as e:
        print(e)
        sys.exit(-3)
    except HDF5Error as e:
        print(e)
        sys.exit(-4)
